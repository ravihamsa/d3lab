<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>d3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            font-size: 13px;
            box-sizing: border-box;
        }


        .no-wrap {
            white-space: nowrap;
        }

        .time-line {
            overflow: hidden;
        }


        .time-line .year , .time-line .month, .time-line .day, .time-line .quarter{
            display: inline-block;
            background-color: #333;
            color:#fff;
            border-right:1px solid #bbb;
            border-bottom: 1px solid #bbb;
            text-align: center;
            padding:4px 0;
            font-size: 16px;
        }

        .time-line .year {

        }
    </style>
    <script src="d3.js"></script>
</head>
<body>

<div id="timeLine"></div>

<script>

    var year = d3.time.format('%Y');
    var day = d3.time.format('%e');
    var month = d3.time.format('%m')
    var monthName = d3.time.format('%b')
    var duration = 400;


    var dayUnitRatio = [1, 30, 90, 365]
    var dayWidthArray = [30, 50/30, 60/90, 80/365]

    var getTranslateXY = function (x, y) {
        return 'translate(' + x + ',' + y + ')';
    }


    var TimeLineWidget = function (config) {
        this.config = config;
        this.rootWidth = parseInt(config.container.style('width'));
        this.rootHeight = 300;
        this.offset = 0;
        this.initialize();
    }


    var yearRollUpFun = function (leaves) {
        return {
            length: leaves.length,
            label: year(leaves[0])
        }
    }

    var monthRollUpFun = function (leaves) {
        return {
            length: leaves.length,
            label: monthName(leaves[0])
        }
    }

    var quarterRollUpFun = function (leaves) {
        return {
            length: leaves.length,
            label: 'Q1'
        }
    }

    var dayRollUpFun = function (leaves) {
        return {
            length: leaves.length,
            label: day(leaves[0])
        }
    }




    TimeLineWidget.prototype = {
        computeConfigs: function(){
            var config = this.config;
            this.dayWidth = dayWidthArray[config.scale];
            this.unitWidth = this.dayWidth * dayUnitRatio[config.scale]
            this.visibleTimeLineDays = Math.ceil(this.rootWidth / this.unitWidth);
            config.container.attr('class','time-line')
        },
        initialize: function () {
            this.computeConfigs();
            this.populateData();
            var config = this.config;
            config.container.append('div').attr('class','year-line no-wrap')
            config.container.append('div').attr('class','month-line no-wrap')
            config.container.append('div').attr('class','quarter-line no-wrap')
            config.container.append('div').attr('class','day-line no-wrap')
        },
        renderTimeLine: function () {
            var scale = this.config.scale;
            this.renderTimeElements('year', function (d) {
                return year(d)
            }, yearRollUpFun, yOffset, 'red')

            var yOffset = 0;


            if(scale ===1 || scale === 0){
                this.renderTimeElements('month', function (d) {
                    return year(d) + '_' + month(d)
                }, monthRollUpFun,  yOffset, 'blue')
                yOffset+=20;
            }else{
                this.rootEl.selectAll('.month').remove();
            }


            if(scale === 2) {
                this.renderTimeElements('quarter', function (d) {
                    return year(d) + '_' + Math.ceil(month(d) / 3);
                }, quarterRollUpFun, yOffset, 'orange')
                yOffset += 20;
            }else{
                this.rootEl.selectAll('.quarter').remove();
            }

            if(scale === 0){
                this.renderTimeElements('day', function (d) {
                    return year(d) + '_' + month(d) + '_' + day(d)
                }, dayRollUpFun,  yOffset, 'green')
                yOffset+=20;
            }else{
                this.rootEl.selectAll('.day').remove();
            }

        },
        renderTimeElements: function (className, keyFun, rollUpFun) {
            var config = this.config;
            var dayWidth = dayWidthArray[config.scale];
            var selector = '.' + className;
            var rootEl = this.rootEl.select(selector+'-line');
            var timeLineData = d3.nest().key(keyFun).rollup(rollUpFun).entries(this.data);

            var elements = rootEl.selectAll(selector)
                    .data(timeLineData, function (d) {
                        return d.id = d.key;
                    });



            elements.exit().remove();

            var elementsEnter = elements.enter()
                    .append('div')
                    .attr('class', className)
                    .style('width', function (d) {
                        return (d.values.length * dayWidth)+'px';
                    })
                    .text(function (d) {
                        return d.values.label;
                    })



            elements.style('width', function (d) {
                        return (d.values.length * dayWidth)+'px';
                    })


        },
        populateData: function () {
            var config = this.config;
            this.data = this.getDateData();
        },
        getDateData: function () {
            var config = this.config;
            var startDate = config.startDate;
            var fromYear = +year(startDate);
            var fromMonth = +month(startDate) - 1;
            var fromDay = +day(startDate);
            var visibleTimeLineDays = this.visibleTimeLineDays;
            var offset = this.offset;
            var offsetAndVisibleUnits = offset + visibleTimeLineDays;

            var from, to, data;

            switch (config.scale) {
                case 0:
                    from = new Date(fromYear, fromMonth, fromDay + offset)
                    to = new Date(fromYear, fromMonth, fromDay + offsetAndVisibleUnits)
                    data = d3.time.day.range(from, to);
                    break;
                case 1:
                    from = new Date(fromYear, fromMonth + offset, fromDay)
                    to = new Date(fromYear, fromMonth + offsetAndVisibleUnits, fromDay)
                    data = d3.time.day.range(from, to);

                case 2:
                    offsetAndVisibleUnits *= 3;
                    from = new Date(fromYear, fromMonth + (offset * 3), fromDay);
                    to = new Date(fromYear, fromMonth + offsetAndVisibleUnits, fromDay)
                    data = d3.time.day.range(from, to);
                    break;
                case 3:
                    from = new Date(fromYear + offset, fromMonth, fromDay);
                    to = new Date(fromYear + offsetAndVisibleUnits, fromMonth, fromDay)
                    data = d3.time.day.range(from, to);
                    break;
            }
            return data;
        },

        render: function () {
            var config = this.config;
            var w = this.rootWidth;
            var h = this.rootHeight;
            var svg = config.container//.append('svg').attr('width', w).attr('height', h);

            this.rootEl = config.container;
            this.renderTimeLine();


        },
        setOffset: function (offset) {
            this.offset = offset;
            this.populateData();
            this.renderTimeLine();
        },
        setConfigs: function(map){
            for(var i in map){
                this.config[i] = map[i];
            }
            this.computeConfigs();
            this.populateData();
            this.renderTimeLine();
        }
    }


    $element = [document.getElementById('timeLine')];
    var scaleArray = ['day', 'month', 'quarter', 'year']
    $scope = {
        scale: 3
    }


    var widget = new TimeLineWidget({
        container: d3.select($element[0]),
        scale: $scope.scale,
        rootHeight: 300,
        dayWidth: 25,
        startDate: new Date(2010, 10, 1)
    })

    widget.render();


    setTimeout(function () {
        widget.setOffset(4);
        widget.setConfigs({scale:2})
    }, 3000)

    setTimeout(function () {
        //widget.setOffset(4000);
        widget.setConfigs({scale:1})
    }, 6000)

    setTimeout(function () {
        //widget.setOffset(4000);
        //widget.setConfigs({scale:0})
    }, 9000)

</script>

</body>
</html>